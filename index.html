<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
        body {
            text-align: center;
            background: rgb(100, 100, 100);
            padding-left: 3vw;
            padding-right: 3vw;
        }

        img {
            width: 1024px;
        }

        a {
            color: orange;
        }

        a:visited {
            color: rgb(198, 109, 0);
        }

        .yyImage {
            border-radius: 2px;
        }

        #badImage {
            border: 5px solid black;
            background: rgba(0,0,0,0.5);
        }

        #goodImage {
            border: 5px solid white;
            background: rgba(255,255,255,0.5);
        }

        #sourceDiv {
            display: none;
            visibility: hidden;
            margin-top: 3vh;
            margin-bottom: 3vh;
        }

        .footer {
            margin-top: 12vh;
            margin-bottom: 3vh;
            margin-left: 4vw;
            margin-right: 4vw;
            padding-top: 1vh;
            border-top: 2px dotted rgb(200, 200, 200);
        }

        #imageDesc span {
            padding-right: 0.2em;
        }

        @media screen and (max-width: 1280px) {
            img {
                width: 768px;
            }
        }

        @media screen and (max-width: 1024px) {
            img {
                width: 512px;
            }
        }

        @media screen and (max-width: 640px) {
            img {
                width: 256px;
            }
        }
    </style>
    <title>üñºÔ∏è‚òØÔ∏è</title>
</head>

<body>
    <h1 style="margin: 5vh 0 5vh 0;">üñºÔ∏è‚òØÔ∏è</h1>

    <img id="sourceImage"
        src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0a/Master_of_the_Fertility_of_the_Egg_-_Curious_scene_with_animals_and_other_fantastical_beasts_making_music%2C_conversing%2C_or_attacking_each_other_from_flying_baskets%2C_as_well_as_a_dancing_skeleto.jpg/980px-thumbnail.jpg" />
    <div id="inputDiv">
        <input id="yinyangUrl" type="text"
            value="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0a/Master_of_the_Fertility_of_the_Egg_-_Curious_scene_with_animals_and_other_fantastical_beasts_making_music%2C_conversing%2C_or_attacking_each_other_from_flying_baskets%2C_as_well_as_a_dancing_skeleto.jpg/980px-thumbnail.jpg"
            size="32" />
        <br />
        <div>
            <input id="openaiKey" type="text" size="32" placeholder="Your OpenAI key..." />
            <br />
            <span style="font-size: 8pt; font-style: italic;">used only for this request; never logged or stored.
                <a href="https://github.com/edfletcher/yinyang/blob/main/src/index.ts" target="_blank">see for yourself.</a>
                <br />creating a new key and revoking it when done here is good hygine regardless.</span>
        </div>
        <br />
        <label for="thresMod" id="thresModLabel">neutral</label>
        <br />
        <input type="range" id="thresMod" name="thresMod" min="-3" max="3" value="0" step="1" />
        <br />
        <button id="yinyang" disabled="true">üñºÔ∏è‚òØÔ∏è</button>
    </div>

    <div id="sourceDiv">
        <div id="imageDesc"></div>
        <div class="footer"></div>

        <img id="badImage" class="yyImage"
            src="https://cdn.pixabay.com/animation/2022/07/29/03/42/03-42-11-849_512.gif" />
        <div id="badPrompt"></div>
        <div class="footer"></div>

        <img id="goodImage" class="yyImage"
            src="https://cdn.pixabay.com/animation/2022/07/29/03/42/03-42-11-849_512.gif" />
        <div id="goodPrompt" style="color: white;"></div>
    </div>

    <div id="footer" class="footer">
        powered by
        <a href="https://platform.openai.com/docs/guides/vision" target="_blank">GPT-4V</a>, CF Workers
        <a href="https://developers.cloudflare.com/workers-ai/models/text-classification/" target="_blank">text
            classification</a> &amp;
        <a href="https://developers.cloudflare.com/workers-ai/models/text-to-image/" target="_blank">text-to-image</a>.
        <br/>
        an <a href="https://github.com/edfletcher" target="_blank">ed fletcher</a> joint.
    </div>
</body>

<script>
    const MOD_LABELS = [
        'negativest',
        'negativer',
        'negative',
        'neutral',
        'positive',
        'positiver',
        'positivest'
    ];

    document.getElementById('yinyangUrl').addEventListener('change', (e) => {
        document.getElementById('sourceImage').src = e.target.value;
    });

    document.getElementById('openaiKey').addEventListener('change', (e) => {
        if ((e.target.value.length === 51 && e.target.value.indexOf('sk-') === 0) || e.target.value.length === 64) {
            document.getElementById('yinyang').disabled = false;
        }
    });

    document.getElementById('thresMod').addEventListener('change', (e) => {
        document.getElementById('thresModLabel').innerText = MOD_LABELS[Number.parseInt(e.target.value) + Number.parseInt(e.target.max)];
    });

    document.getElementById('yinyang').addEventListener('click', async () => {
        document.getElementById('yinyang').parentElement.removeChild(document.getElementById('yinyang'));
        document.getElementById('yinyangUrl').disabled = true;
        const imageUrl = document.getElementById('yinyangUrl').value;
        const sourceDiv = document.getElementById('sourceDiv');
        sourceDiv.style.display = 'block';
        sourceDiv.style.visibility = 'visible';
        document.getElementById('thresMod').disabled = true;
        const oaiKeyEle = document.getElementById('openaiKey');
        const openaiKey = oaiKeyEle.value;
        oaiKeyEle.parentElement.parentElement.removeChild(oaiKeyEle.parentElement);

        document.getElementById('sourceImage').src = imageUrl;
        document.title = '‚è≥  üñºÔ∏è‚òØÔ∏è';
        const result = await fetch(`https://yinyang.llamas.computerpho.be/?imageUrl=${encodeURI(imageUrl)}`, {
            headers: {
                'X-Yinyang-OpenAI-Key': openaiKey,
                'X-Yinyang-Threshold-Mod': document.getElementById('thresMod').value,
            }
        });
        document.title = 'üñºÔ∏è‚òØÔ∏è';
        const { response, sentences, results: { good, bad }, meta } = await result.json();
        console.log(response, sentences, good, bad, meta);

        const imageDesc = document.getElementById('imageDesc');
        sentences.forEach(({ sentence, sentiment: { good } }) => {
            const ele = document.createElement('span');
            ele.style.color = good ? 'white' : 'black';
            ele.innerText = sentence + '.';
            imageDesc.appendChild(ele);
        });

        document.getElementById('goodImage').src = `data:image/png;base64,${good.imageBase64}`;
        document.getElementById('goodPrompt').innerText = good.prompt;

        document.getElementById('badImage').src = `data:image/png;base64,${bad.imageBase64}`;
        document.getElementById('badPrompt').innerText = bad.prompt;
    })
</script>
<script data-goatcounter="https://yinyang.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>

</html>